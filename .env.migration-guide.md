# üîí GUIDE DE MIGRATION DES SECRETS - FELORA V3

**Date:** $(date +%Y-%m-%d)
**Action:** R√©g√©n√©ration des cl√©s API suite √† l'audit de s√©curit√©

---

## ‚ö†Ô∏è SECRETS √Ä R√âG√âN√âRER IMM√âDIATEMENT

### 1. Cloudflare R2 (CRITIQUE)
- **Service:** Cloudflare Dashboard > R2 > Manage R2 API Tokens
- **Variables:**
  - `CLOUDFLARE_R2_ACCESS_KEY` ‚ùå √Ä r√©g√©n√©rer
  - `CLOUDFLARE_R2_SECRET_KEY` ‚ùå √Ä r√©g√©n√©rer
- **Action:** Cr√©er nouveau token, r√©voquer l'ancien
- **Impact:** Aucun si fait rapidement (les uploads continuent)

### 2. Resend (Email) (CRITIQUE)
- **Service:** https://resend.com/api-keys
- **Variable:** `RESEND_API_KEY` ‚ùå √Ä r√©g√©n√©rer
- **Action:** Cr√©er nouvelle cl√©, supprimer l'ancienne
- **Impact:** Les emails ne partiront plus avec l'ancienne cl√©

### 3. Bunny.net Stream (HAUTE)
- **Service:** https://bunny.net (Account Settings > API)
- **Variables:**
  - `BUNNY_STREAM_API_KEY` ‚ùå √Ä r√©g√©n√©rer
  - `BUNNY_STREAM_TOKEN_AUTH_KEY` ‚ùå √Ä r√©g√©n√©rer
- **Action:** G√©n√©rer nouvelles cl√©s
- **Impact:** Les vid√©os ne se chargeront plus avec anciennes cl√©s

### 4. Mux Video (HAUTE)
- **Service:** https://dashboard.mux.com
- **Variables:**
  - `MUX_TOKEN_ID` ‚ùå √Ä r√©g√©n√©rer
  - `MUX_TOKEN_SECRET` ‚ùå √Ä r√©g√©n√©rer
- **Action:** Cr√©er nouveau token
- **Impact:** Transcoding vid√©o s'arr√™te

### 5. Livepeer (MOYENNE)
- **Service:** https://livepeer.studio/dashboard/developers/api-keys
- **Variable:** `LIVEPEER_API_KEY` ‚ùå √Ä r√©g√©n√©rer
- **Action:** Cr√©er nouvelle cl√©
- **Impact:** Video streaming affect√©

### 6. NextAuth Secret (CRITIQUE)
- **Variable:** `NEXTAUTH_SECRET`
- **Valeur actuelle:** ‚ùå Trop faible ("your-super-secret-key-change-this-in-production")
- **Action:** G√©n√©rer une nouvelle cl√© forte
- **Commande:**
  ```bash
  openssl rand -base64 32
  ```
- **Impact:** ‚ö†Ô∏è TOUS LES UTILISATEURS SERONT D√âCONNECT√âS

### 7. Admin Credentials (CRITIQUE)
- **Variables:**
  - `ADMIN_EMAIL` (actuellement: info@devcom.ch)
  - `ADMIN_PASSWORD` (actuellement: Devcom20!)
- **Action:**
  1. G√©n√©rer hash bcrypt du nouveau mot de passe
  2. Cr√©er `ADMIN_PASSWORD_HASH` au lieu de `ADMIN_PASSWORD`
  3. Cr√©er `ADMIN_JWT_SECRET` pour les tokens
- **Commande:**
  ```bash
  # G√©n√©rer hash bcrypt
  node -e "const bcrypt = require('bcryptjs'); console.log(bcrypt.hashSync('NOUVEAU_MOT_DE_PASSE_FORT', 10))"
  
  # G√©n√©rer JWT secret
  openssl rand -base64 32
  ```

### 8. Media Signature Secret (MOYENNE)
- **Variable:** `MEDIA_SIGNATURE_SECRET`
- **Valeur actuelle:** Pr√©visible
- **Action:** G√©n√©rer nouvelle cl√© al√©atoire
- **Commande:**
  ```bash
  openssl rand -hex 32
  ```

---

## ‚úÖ SECRETS √Ä CONSERVER (OK)

- `DATABASE_URL` - Connexion Neon DB (OK tant que priv√©)
- `NEXT_PUBLIC_*` - Variables publiques (OK par design)
- `SUPABASE_SERVICE_KEY` - Visible mais read-only (OK si limit√©)

---

## üìã PROC√âDURE DE MIGRATION

### √âtape 1 : Pr√©paration (5 min)
```bash
# Cr√©er un nouveau fichier .env.new avec les nouvelles cl√©s
cp .env.example .env.new
```

### √âtape 2 : R√©g√©n√©ration des Cl√©s (30 min)
1. Cloudflare R2 - G√©n√©rer nouveau token
2. Resend - Cr√©er nouvelle cl√© API
3. Bunny.net - G√©n√©rer nouvelles cl√©s
4. Mux - Cr√©er nouveau token
5. Livepeer - G√©n√©rer nouvelle cl√©
6. NextAuth - G√©n√©rer secret fort
7. Admin - Hasher nouveau mot de passe

### √âtape 3 : Mise √† Jour Vercel (5 min)
```bash
# Via Vercel CLI
vercel env add CLOUDFLARE_R2_ACCESS_KEY production
vercel env add CLOUDFLARE_R2_SECRET_KEY production
# ... r√©p√©ter pour toutes les variables
```

### √âtape 4 : Test en Local (10 min)
```bash
# Utiliser .env.new
mv .env.local .env.local.old
mv .env.new .env.local

# D√©marrer l'app
npm run dev

# Tester:
# - Upload image
# - Upload vid√©o
# - Envoi email
# - Login admin
```

### √âtape 5 : D√©ploiement Production (2 min)
```bash
# Push les changements de code (si n√©cessaire)
git add src/app/api/admin/auth/login/route.ts  # Code corrig√©
git commit -m "security: Improve admin auth with JWT"
git push

# Red√©marrer Vercel pour charger nouvelles env vars
vercel --prod
```

### √âtape 6 : R√©vocation Anciennes Cl√©s (5 min)
‚ö†Ô∏è **IMPORTANT:** Ne faire qu'APR√àS confirmation que tout fonctionne !

1. Cloudflare - Supprimer ancien token R2
2. Resend - Supprimer ancienne cl√©
3. Bunny.net - Supprimer anciennes cl√©s
4. Mux - R√©voquer ancien token
5. Livepeer - Supprimer ancienne cl√©

---

## üß™ TESTS DE VALIDATION

### Checklist Post-Migration
- [ ] Upload image fonctionne (R2)
- [ ] Upload vid√©o fonctionne (Bunny.net)
- [ ] Email de v√©rification envoy√© (Resend)
- [ ] Login utilisateur fonctionne (NextAuth)
- [ ] Login admin fonctionne (JWT)
- [ ] Vid√©os se chargent (Bunny CDN)
- [ ] Aucune erreur dans Vercel logs

### Rollback Plan
Si probl√®me critique :
```bash
# Restaurer anciennes variables
mv .env.local.old .env.local

# Ou sur Vercel
vercel env pull .env.local
```

---

## üìû SUPPORT

- **Cloudflare:** https://dash.cloudflare.com
- **Resend:** https://resend.com/emails
- **Bunny.net:** https://panel.bunny.net
- **Vercel:** https://vercel.com/dashboard

---

**Temps total estim√©:** ~1 heure
**Difficult√©:** Moyenne
**Impact:** Critique pour s√©curit√©
